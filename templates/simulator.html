<!DOCTYPE html>
<html>
<head>
<title>Bus Simulator</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body { margin:0; background:#0f0f23; color:#e6eef8; font-family:'Segoe UI',sans-serif; }
#map { height:100vh; }
.controls {
  position:absolute; top:12px; left:12px; background:rgba(18,24,38,0.92);
  padding:14px 16px; border-radius:12px; z-index:1000; min-width:220px;
  border:1px solid rgba(255,255,255,0.08); backdrop-filter:blur(12px);
  box-shadow:0 8px 32px rgba(0,0,0,0.5);
}
.controls label { display:block; font-size:12px; color:#9aa4b2; margin-top:8px; }
.controls select, .controls input[type=number] {
  width:100%; padding:6px 8px; border-radius:6px; border:1px solid rgba(255,255,255,0.1);
  background:#0f0f23; color:#e6eef8; font-size:13px; margin-top:2px;
}
.controls input[type=range] { width:100%; margin-top:2px; }
.speed-row { display:flex; align-items:center; gap:8px; margin-top:4px; }
.speed-row input[type=range] { flex:1; min-width:0; }
.speed-row input[type=number] {
  width:64px; flex:none; padding:4px 6px; border-radius:6px;
  border:1px solid rgba(255,255,255,0.1); background:#0f0f23;
  color:#34d399; font-size:13px; font-weight:600; text-align:center;
  -moz-appearance:textfield;
  appearance:textfield;
}
.speed-row input[type=number]::-webkit-inner-spin-button,
.speed-row input[type=number]::-webkit-outer-spin-button { opacity:1; }
.speed-unit { font-size:11px; color:#667; flex:none; }
.keys-hint { font-size:11px; color:#667; margin-top:10px; line-height:1.6; }
.keys-hint kbd {
  background:rgba(255,255,255,0.08); padding:2px 6px; border-radius:4px;
  border:1px solid rgba(255,255,255,0.15); font-family:monospace; font-size:11px;
}
.status-dot { display:inline-block; width:6px; height:6px; border-radius:50%; background:#34d399; margin-right:6px;
  box-shadow:0 0 6px rgba(52,211,153,0.5); }
#syncStatus { font-size:11px; color:#9aa4b2; margin-top:8px; }
#startBtn {
  width:100%; margin-top:12px; padding:8px 0; border:none; border-radius:8px;
  background:rgba(52,211,153,0.15); color:#34d399; font-size:13px; font-weight:600;
  cursor:pointer; transition:all 0.2s;
}
#startBtn:hover:not(:disabled) { background:rgba(52,211,153,0.25); }
#startBtn:disabled { opacity:0.35; cursor:not-allowed; }
#startBtn.running { background:rgba(251,113,133,0.15); color:#fb7185; }
#startBtn.running:hover { background:rgba(251,113,133,0.25); }
</style>
</head>
<body>

<div class="controls">
  <div style="font-weight:600; font-size:14px; margin-bottom:6px;">üöç Bus Simulator</div>

  <label>Bus Number
    <select id="busSelect"><option value="" selected>‚Äî Select Bus ‚Äî</option></select>
  </label>

  <label>Route
    <select id="routeSelect"><option value="" selected>‚Äî Select Route ‚Äî</option></select>
  </label>

  <label>Speed (km/h)
    <div class="speed-row">
      <input type="range" id="speedSlider" min="1" max="200" step="1" value="50"/>
      <input type="number" id="customSpeed" min="1" max="200" step="1" value="50"/>
      <span class="speed-unit">km/h</span>
    </div>
  </label>

  <div class="keys-hint">
    <kbd>W</kbd><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd> to drive<br>
    <kbd>Shift</kbd> to boost &nbsp; <kbd>Space</kbd> to brake
  </div>

  <div id="syncStatus"><span class="status-dot" style="background:#667"></span>Waiting to start...</div>
  <button id="startBtn" disabled>Select bus & route first</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// --- State ---
let lat = 20.3549, lng = 85.8161;
let bus = null;
let currentRouteId = null;
let simRunning = false;

// Physics
const BOOST = 2.5;           // shift multiplier

// --- Map ---
const map = L.map("map").setView([lat, lng], 16);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', { maxZoom:19 }).addTo(map);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', { maxZoom:19 }).addTo(map);

const marker = L.circleMarker([lat, lng], {
  radius: 8, color: '#34d399', weight: 3, fillColor: '#34d399', fillOpacity: 0.9
}).addTo(map);

// Trail for visual feedback
const trail = L.polyline([], { color: '#34d39955', weight: 2, dashArray: '4,4' }).addTo(map);
const trailPoints = [];
const MAX_TRAIL = 200;

// --- Route display on map ---
let routePolyline = null;
let routeStopMarkers = [];
let allRoutesData = [];

async function osrmRoute(waypoints) {
  if (waypoints.length < 2) return waypoints;
  try {
    const coords = waypoints.map(wp => `${wp[1]},${wp[0]}`).join(';');
    const res = await fetch(`https://router.project-osrm.org/route/v1/driving/${coords}?geometries=geojson`);
    const data = await res.json();
    if (data.routes && data.routes[0]) return data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
  } catch(e) {}
  return waypoints;
}

function clearRouteDisplay() {
  if (routePolyline) { map.removeLayer(routePolyline); routePolyline = null; }
  routeStopMarkers.forEach(m => map.removeLayer(m));
  routeStopMarkers = [];
}

async function showRouteOnMap(routeId) {
  clearRouteDisplay();
  if (!routeId) return;
  const route = allRoutesData.find(r => String(r.id) === String(routeId));
  if (!route || !route.waypoints || route.waypoints.length < 2) return;

  const coords = await osrmRoute(route.waypoints);
  routePolyline = L.polyline(coords, {
    color: route.color || '#667eea', weight: 4, opacity: 0.7, dashArray: '8,6'
  }).addTo(map);

  route.waypoints.forEach((wp, idx) => {
    const name = (route.stops && route.stops[idx]) || `Stop ${idx+1}`;
    const dot = L.circleMarker(wp, {
      radius: 5, color: route.color || '#667eea', weight: 2,
      fillColor: '#fff', fillOpacity: 0.9
    }).addTo(map);
    dot.bindTooltip(name, { direction: 'top', offset: [0, -8] });
    routeStopMarkers.push(dot);
  });
}

// --- Controls ---
function updateStartBtn() {
  const btn = document.getElementById('startBtn');
  if (simRunning) {
    btn.textContent = '‚èπ Stop Simulation';
    btn.className = 'running';
    btn.disabled = false;
  } else if (bus && currentRouteId) {
    btn.textContent = '‚ñ∂ Start Simulation';
    btn.className = '';
    btn.disabled = false;
  } else {
    btn.textContent = 'Select bus & route first';
    btn.className = '';
    btn.disabled = true;
  }
}

function initBusSelect() {
  const sel = document.getElementById("busSelect");
  for (let i = 1; i <= 20; i++) {
    const o = document.createElement("option");
    o.value = i; o.text = "Bus " + i;
    sel.appendChild(o);
  }
  sel.onchange = () => {
    bus = sel.value ? parseInt(sel.value) : null;
    updateStartBtn();
  };
}

async function initRouteSelect() {
  try {
    const res = await fetch("/api/routes");
    const routes = await res.json();
    allRoutesData = routes;
    const sel = document.getElementById("routeSelect");
    routes.forEach(r => {
      const o = document.createElement("option");
      o.value = r.id; o.text = r.name;
      sel.appendChild(o);
    });
    sel.onchange = () => {
      currentRouteId = sel.value || null;
      showRouteOnMap(currentRouteId);
      updateStartBtn();
      if (currentRouteId && bus && simRunning) {
        fetch(`/api/bus/${bus}/route`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ routeId: currentRouteId })
        }).catch(() => {});
      }
    };
  } catch (e) { console.warn("Failed to load routes:", e); }
}

// Speed controls ‚Äî slider and number input are synced (both in km/h)
const speedSlider = document.getElementById('speedSlider');
const customSpeedInput = document.getElementById('customSpeed');
let targetKmh = 50; // current speed in km/h

function setSpeed(kmh) {
  kmh = Math.max(1, Math.min(200, Math.round(kmh)));
  targetKmh = kmh;
  speedSlider.value = kmh;
  customSpeedInput.value = kmh;
}

speedSlider.addEventListener('input', () => { setSpeed(parseFloat(speedSlider.value)); });
customSpeedInput.addEventListener('input', () => { setSpeed(parseFloat(customSpeedInput.value) || 1); });
customSpeedInput.addEventListener('change', () => { setSpeed(parseFloat(customSpeedInput.value) || 1); });

// Try to center on user location
navigator.geolocation.getCurrentPosition((pos) => {
  lat = pos.coords.latitude;
  lng = pos.coords.longitude;
  map.setView([lat, lng], 16);
  marker.setLatLng([lat, lng]);
});

// --- Input ---
const keys = {};
document.addEventListener("keydown", e => { keys[e.key.toLowerCase()] = true; e.preventDefault(); });
document.addEventListener("keyup", e => { keys[e.key.toLowerCase()] = false; });

// --- Animation Loop ---
let lastFrame = performance.now();
let lastSend = 0;
const SEND_INTERVAL = 200; // ms between server updates

function animate(now) {
  const dt = Math.min(0.1, (now - lastFrame) / 1000); // cap at 100ms to avoid jumps
  lastFrame = now;

  const boost = keys["shift"] ? BOOST : 1;
  const speedDegPerSec = (targetKmh / 3.6) / 111320; // convert km/h to degrees/sec

  let dx = 0, dy = 0;
  if (keys["w"]) dy = 1;
  if (keys["s"]) dy = -1;
  if (keys["d"]) dx = 1;
  if (keys["a"]) dx = -1;

  // Normalize diagonal movement
  const mag = Math.sqrt(dx * dx + dy * dy) || 1;
  dx /= mag; dy /= mag;

  if (dx !== 0 || dy !== 0) {
    lat += dy * speedDegPerSec * boost * dt;
    lng += dx * speedDegPerSec * boost * dt;
  }

  // Update marker
  marker.setLatLng([lat, lng]);

  // Trail
  trailPoints.push([lat, lng]);
  if (trailPoints.length > MAX_TRAIL) trailPoints.shift();
  trail.setLatLngs(trailPoints);

  // Soft camera follow ‚Äî pan only when near edge
  try {
    const px = map.latLngToContainerPoint([lat, lng]);
    const sz = map.getSize();
    const m = 60;
    if (px.x < m || px.x > sz.x - m || px.y < m || px.y > sz.y - m) {
      map.panTo([lat, lng], { animate: true, duration: 0.3 });
    }
  } catch (e) {}

  // Send updates to server only when simulation is running
  if (simRunning && bus && now - lastSend >= SEND_INTERVAL) {
    lastSend = now;
    const payload = { lat, lng, lastUpdate: new Date().toISOString() };
    if (currentRouteId) payload.routeId = currentRouteId;
    fetch(`/api/bus/${bus}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    }).then(() => {
      document.getElementById('syncStatus').innerHTML = '<span class="status-dot"></span>Synced';
    }).catch(() => {
      document.getElementById('syncStatus').innerHTML = '<span class="status-dot" style="background:#fb7185"></span>Offline';
    });
  }

  requestAnimationFrame(animate);
}

initBusSelect();
initRouteSelect();

// Start/Stop button
document.getElementById('startBtn').addEventListener('click', () => {
  if (simRunning) {
    simRunning = false;
    // Notify server to remove this bus
    if (bus) {
      fetch(`/api/bus/${bus}`, { method: 'DELETE' }).catch(() => {});
    }
    document.getElementById('syncStatus').innerHTML = '<span class="status-dot" style="background:#667"></span>Stopped';
  } else {
    if (!bus || !currentRouteId) return;
    simRunning = true;
    // Assign route on server
    fetch(`/api/bus/${bus}/route`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ routeId: currentRouteId })
    }).catch(() => {});
    document.getElementById('syncStatus').innerHTML = '<span class="status-dot"></span>Syncing...';
  }
  updateStartBtn();
});

requestAnimationFrame(animate);
</script>
</body>
</html>

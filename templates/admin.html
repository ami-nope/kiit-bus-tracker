<!DOCTYPE html>
<html>
<head>
    <title>Transport Tracker - Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0b0c10; color:#e6eef8; padding:24px; }
        .panel { max-width:1400px; margin: 0 auto; background: #0d1117; border-radius:12px; padding:18px; border:1px solid rgba(255,255,255,0.04); box-shadow: none }
        h1 { margin:0 0 6px 0; font-size:20px }
        p.subtitle { margin:0 0 14px 0; color:#9aa4b2 }
        .controls { display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap }
        input, select, textarea { padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:#0f0f23; color:#e6eef8 }
        button { background:#0f0f23; color:#e6eef8; border:1px solid rgba(255,255,255,0.06); padding:8px 12px; border-radius:10px; cursor:pointer }
        button:hover { background:rgba(255,255,255,0.05) }
        table { width:100%; border-collapse:collapse; margin-top:12px }
        thead th { text-align:left; padding:10px; font-size:13px; color:#9aa4b2; border-bottom:1px solid rgba(255,255,255,0.03) }
        tbody td { padding:10px; vertical-align:middle; border-bottom:1px dashed rgba(255,255,255,0.02) }
        .small { font-size:13px; color:#9aa4b2 }
        .muted { color:#8893a6 }
        .danger { color:#ff7b8a; border-color: rgba(255,123,138,0.12) }
        .ok { color:#34d399; border-color: rgba(52,211,153,0.08) }
        .row-actions button { margin-right:8px }
        .empty { text-align:center; color:#8290a3; padding:20px }
        .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:20px }
        .tabs { display:flex; gap:8px; border-bottom:1px solid rgba(255,255,255,0.03); margin-bottom:18px }
        .tab { padding:10px 16px; cursor:pointer; color:#9aa4b2; border-bottom:2px solid transparent }
        .tab.active { color:#e6eef8; border-bottom-color:#34d399 }
        .tab-content { display:none }
        .tab-content.active { display:block }
        .field-group { margin-bottom:12px }
        .field-label { font-size:12px; color:#9aa4b2; margin-bottom:4px; display:block; font-weight:600 }
        
        /* Route Builder */
        #routeMap { height:500px; border-radius:8px; margin-bottom:16px; border:2px solid rgba(102,126,234,0.3) }
        .route-builder { display:grid; grid-template-columns:1.2fr 1fr; gap:20px; margin-bottom:20px }
        @media (max-width:1000px) { .route-builder { grid-template-columns:1fr } }
        
        .route-panel { background:#0f0f23; padding:18px; border-radius:10px; border:1px solid rgba(255,255,255,0.06) }
        .step-indicator { display:flex; gap:10px; margin-bottom:18px }
        .step { padding:8px 12px; border-radius:6px; font-size:12px; text-align:center; flex:1; background:#0d1117; color:#9aa4b2; font-weight:500 }
        .step.active { background:#667eea; color:#fff; box-shadow:0 0 12px rgba(102,126,234,0.4) }
        .step.done { background:#34d399; color:#fff }
        
        .instruction-box { background:rgba(102,126,234,0.1); padding:12px; border-radius:6px; border:1px solid rgba(102,126,234,0.2); margin-bottom:14px; font-size:13px; line-height:1.5 }
        .instruction-main { font-size:14px; font-weight:600; color:#667eea; margin-bottom:4px }
        .instruction-sub { color:#9aa4b2; margin-top:2px }
        
        .stops-list { max-height:450px; overflow-y:auto; background:#0d1117; border-radius:6px; padding:10px }
        .stop-item { padding:10px; background:#07101a; border-radius:6px; margin-bottom:8px; border-left:4px solid; display:flex; gap:8px; align-items:center; font-size:13px }
        .stop-item.start { border-left-color:#4CAF50; background:#0d1117 }
        .stop-item input { flex:1; background:#0f0f23; border:1px solid rgba(255,255,255,0.04); color:#e6eef8; padding:6px 8px; border-radius:4px }
        .stop-num { min-width:28px; text-align:center; color:#9aa4b2; font-weight:bold; font-size:12px }
        .stop-icon { font-size:16px }
        /* Unified icon styling */
        .icon { display:inline-block; font-size:14px; line-height:1; vertical-align:middle; opacity:0.9; margin-right:6px }
        .tab .icon { font-size:16px; opacity:0.85 }
        .field-label .icon { font-size:14px }
        .route-panel h3 .icon { font-size:15px }
        .stop-icon { font-size:13px }
        /* Map tiny markers (fixed pixel size, crisp) */
        .tiny-marker { width:8px; height:8px; border-radius:50%; display:inline-block; border:1px solid rgba(255,255,255,0.5) }
        .tiny-marker:hover { transform: none; }
        .tiny-start { width:10px; height:10px; background:#4CAF50 }
        .tiny-hostel { background:#9C27B0 }
        .tiny-class { background:#2196F3 }
        .tiny-stop { background:#667eea }
        .marker-wrapper { width:10px; height:10px }
        /* Remove default white background from DivIcons */
        .leaflet-div-icon { background: transparent !important; border: none !important; }
        
        .button-group { display:flex; gap:8px; margin-top:14px }
        .button-group button { flex:1 }
        
        .routes-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:12px; margin-top:12px }
        .route-card { background:#0f0f23; padding:12px; border-radius:10px; border-left:5px solid; border:1px solid rgba(255,255,255,0.06) }
        .route-badge { display:inline-block; padding:4px 8px; border-radius:999px; font-size:11px; font-weight:600 }
        .badge-running { background:rgba(52,211,153,0.12); color:#34d399; border:1px solid rgba(52,211,153,0.25) }
        .badge-idle { background:rgba(255,154,162,0.1); color:#ff9aa2; border:1px solid rgba(255,154,162,0.25) }
        .route-name { font-weight:600; margin-bottom:4px }
        .route-info { font-size:12px; color:#9aa4b2; margin-bottom:8px }
        .route-actions { display:flex; gap:6px }
        .route-actions button { flex:1; font-size:12px; padding:6px }
        
        cursor-info { font-size:11px; color:#667eea; text-align:center; margin-top:8px; display:block }
    </style>
</head>
<body>
    <div class="panel">
        <div class="topbar">
            <div>
                <div style="font-weight:700; font-size:14px; color:#e6eef8">{{ institute_name | default('INSTITUTE') }} TRANSPORT SYSTEM</div>
                <h1>üõ£Ô∏è Route Builder</h1>
                <p class="subtitle">Create routes by clicking on the map - no coordinates needed!</p>
                <div class="controls" style="margin-top:8px">
                    <label class="field-label" for="totalTransportsInput">Total Transports</label>
                    <button id="decTotalTransports">‚àí</button>
                    <input id="totalTransportsInput" type="number" min="0" value="100" style="width:100px">
                    <button id="incTotalTransports">+</button>
                    <button id="saveTotalTransports" class="ok">Save</button>
                </div>
            </div>
            <div style="text-align:right">
                <a href="/" target="_blank" rel="noopener noreferrer" style="color:#9aa4b2; text-decoration:none; margin-right:12px">Student View</a>
                <a href="/driver" target="_blank" rel="noopener noreferrer" style="color:#9aa4b2; text-decoration:none; margin-right:12px">Driver View</a>
                <button onclick="showUsersSection()" style="background:#34d399;color:#042017;margin-right:12px;padding:8px 16px;border-radius:8px;border:none;cursor:pointer">Users</button>
                {% if admin_user %}
                    <span style="color:#9aa4b2; margin-right:8px">{{ admin_user }}</span>
                    <a href="/admin/logout" style="color:#ff9aa2; text-decoration:none">Logout</a>
                {% else %}
                    <a href="/admin/login" style="color:#9aa4b2; text-decoration:none">Admin Login</a>
                {% endif %}
            </div>
        </div>

        <div class="tabs">
            <div class="tab" data-tab="routes"><span class="icon">üó∫Ô∏è</span> Create Route</div>
            <div class="tab active" data-tab="buses"><span class="icon">üöå</span> Manage Transports</div>
            <div class="tab" data-tab="buildings"><span class="icon">üè†</span> Buildings</div>
        </div>
        <div id="usersSection" style="display:none;background:#07101a;padding:18px;border-radius:8px;margin-bottom:18px">
            <h2 style="color:#34d399">All Users</h2>
            <div id="usersTable"></div>
            <h3 style="margin-top:16px;color:#e6eef8;font-size:16px">Manage Admins</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center">
                <input id="adminUsername" placeholder="Username" style="min-width:160px">
                <div style="display:flex;gap:8px;align-items:center">
                    <input id="adminPassword" type="password" placeholder="Password" style="min-width:160px">
                    <button type="button" onclick="toggleVisibility('adminPassword', this)" style="margin-top:0;background:#667eea;color:#fff">Show</button>
                </div>
                <input id="adminPin" placeholder="Pin (456123)" style="min-width:140px">
                <button class="ok" onclick="addAdmin()">+ Add Admin</button>
            </div>
            <div id="adminsTable"></div>
            <button onclick="hideUsersSection()" style="margin-top:12px;background:#ff7b8a;color:#fff;padding:8px 16px;border-radius:8px;border:none;cursor:pointer">Close</button>
        </div>
        <script>
        function showUsersSection() {
            fetch('/admin/users').then(r=>r.json()).then(data=>{
                let html = '<table style="width:100%;margin-top:12px"><thead><tr><th>Type</th><th>Username</th><th>Password</th></tr></thead><tbody>';
                for(let user of data.users){
                    html += `<tr><td>${user.type}</td><td>${user.username}</td><td>${user.password}</td></tr>`;
                }
                html += '</tbody></table>';
                document.getElementById('usersTable').innerHTML = html;
                document.getElementById('usersSection').style.display = 'block';
            }).then(()=>{
                loadAdmins();
            });
        }
        function hideUsersSection(){
            document.getElementById('usersSection').style.display = 'none';
        }

        function loadAdmins(){
            fetch('/admin/admins').then(r=>r.json()).then(data=>{
                const admins = data.admins || [];
                let html = '<table style="width:100%;margin-top:8px"><thead><tr><th>Admin</th><th style="width:280px">Actions</th></tr></thead><tbody>';
                if(admins.length===0){
                    html += '<tr><td colspan="2" class="empty">No admins yet</td></tr>';
                } else {
                    for(let a of admins){
                        html += `<tr>
                            <td><strong>${a.username}</strong></td>
                            <td class="row-actions">
                                <button onclick="promptChangeAdminPassword('${a.username}')">Change Password</button>
                                <button class="danger" onclick="deleteAdmin('${a.username}')">Delete</button>
                            </td>
                        </tr>`;
                    }
                }
                html += '</tbody></table>';
                document.getElementById('adminsTable').innerHTML = html;
            });
        }

        function addAdmin(){
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            const pin = document.getElementById('adminPin').value.trim();
            if(!username || !password || !pin){ alert('Enter username, password and pin'); return; }
            fetch('/admin/admins', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ username, password, pin })
            }).then(async r=>{
                if(!r.ok){ const e = await r.json(); alert(e.error||'Failed'); return; }
                document.getElementById('adminUsername').value='';
                document.getElementById('adminPassword').value='';
                document.getElementById('adminPin').value='';
                loadAdmins();
            });
        }

        function deleteAdmin(username){
            fetch(`/admin/admins/${encodeURIComponent(username)}`, { method:'DELETE' }).then(async r=>{
                if(!r.ok){ const e = await r.json(); alert(e.error||'Failed'); return; }
                loadAdmins();
            });
        }

        function promptChangeAdminPassword(username){
            const pwd = prompt(`New password for ${username}:`);
            if(pwd===null) return;
            const pin = prompt('Enter pin (456123):');
            if(pin===null) return;
            changeAdminPassword(username, pwd, pin);
        }

        function changeAdminPassword(username, password, pin){
            if(!password || !pin){ alert('Password and pin are required'); return; }
            fetch(`/admin/admins/${encodeURIComponent(username)}/password`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ password, pin })
            }).then(async r=>{
                if(!r.ok){ const e = await r.json(); alert(e.error||'Failed'); return; }
                alert('Password updated');
            });
        }
        function toggleVisibility(id, btn){
            const el = document.getElementById(id);
            if(!el) return;
            const isPwd = el.type === 'password';
            el.type = isPwd ? 'text' : 'password';
            if(btn) btn.textContent = isPwd ? 'Hide' : 'Show';
        }
        </script>
        <script>
        
        async function loadTotalTransports(){
            try{
                const res = await fetch('/api/metrics');
                const data = await res.json();
                const val = typeof data.total_transports === 'number' ? data.total_transports : 100;
                const input = document.getElementById('totalTransportsInput');
                if(input) input.value = val;
            }catch(e){ /* ignore */ }
        }
        function initTotalTransportControls(){
            const input = document.getElementById('totalTransportsInput');
            const dec = document.getElementById('decTotalTransports');
            const inc = document.getElementById('incTotalTransports');
            const save = document.getElementById('saveTotalTransports');
            if(dec) dec.addEventListener('click', ()=>{ const v = Math.max(0, parseInt(input.value||'0')-1); input.value = v; });
            if(inc) inc.addEventListener('click', ()=>{ const v = Math.max(0, parseInt(input.value||'0')+1); input.value = v; });
            if(save) save.addEventListener('click', async ()=>{
                const v = Math.max(0, parseInt(input.value||'0'));
                await fetch('/api/metrics', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ total_transports: v }) });
                alert('Saved');
            });
        }
        document.addEventListener('DOMContentLoaded', ()=>{ loadTotalTransports(); initTotalTransportControls(); });
        </script>

        <!-- ROUTES TAB -->
        <div id="routes" class="tab-content">
            <div class="route-builder">
                <!-- MAP SECTION -->
                <div>
                    <div class="field-label" style="margin-bottom:8px">üìç Click on map to add stops</div>
                    <div id="routeMap"></div>
                    <cursor-info id="cursorInfo">üëÜ Click on map | First click = Start Point | Next clicks = Stops</cursor-info>
                </div>
                
                <!-- CONTROLS -->
                <div>
                    <div class="route-panel">
                        <h3 style="margin:0 0 16px 0; font-size:15px">Route Details</h3>
                        
                        <!-- Step Indicator -->
                        <div class="step-indicator">
                            <div class="step active" id="step1">1. Start</div>
                            <div class="step" id="step2">2. Stops</div>
                            <div class="step" id="step3">3. Save</div>
                        </div>

                        <!-- Instructions -->
                        <div class="instruction-box">
                            <div class="instruction-main" id="mainInstruction">Step 1: Click on map to set START point</div>
                            <div class="instruction-sub" id="subInstruction">First click anywhere on the map</div>
                        </div>

                        <!-- Route Name -->
                        <div class="field-group">
                            <label class="field-label">Route Name</label>
                            <input id="routeName" placeholder="e.g. North Campus Loop" style="width:100%">
                        </div>

                        <!-- Color -->
                        <div class="field-group">
                            <label class="field-label">Route Color</label>
                            <select id="routeColor" style="width:100%">
                                <option value="#FF5722">üî¥ Red-Orange</option>
                                <option value="#2196F3">üîµ Blue</option>
                                <option value="#4CAF50">üü¢ Green</option>
                                <option value="#FF9800">üü† Orange</option>
                                <option value="#9C27B0">üü£ Purple</option>
                                <option value="#00BCD4">üî∑ Cyan</option>
                                <option value="#E91E63">üíó Pink</option>
                                <option value="#FFEB3B">üü° Yellow</option>
                            </select>
                        </div>

                        <!-- Stops List -->
                        <div class="field-group">
                            <label class="field-label">Stops (<span id="stopCount">0</span>)</label>
                            <div class="stops-list" id="stopsList"></div>
                        </div>

                        <!-- Buttons -->
                        <div class="button-group">
                            <button id="clearMapBtn" class="danger" style="background:rgba(255,123,138,0.05)">üóëÔ∏è Clear</button>
                            <button id="saveRouteBtn" class="ok" style="background:rgba(52,211,153,0.1)">üíæ Save Route</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EXISTING ROUTES -->
            <h3 style="margin-top:28px; margin-bottom:14px; font-size:16px">üìö Your Routes</h3>
            <div class="routes-grid" id="routesList"></div>
        </div>

        <!-- TRANSPORTS TAB -->
        <div id="buses" class="tab-content active">
            <div class="controls">
                <input id="newBusNum" placeholder="Transport number (e.g. 21)" style="width:140px">
                <input id="newLat" placeholder="Latitude" style="width:160px">
                <input id="newLng" placeholder="Longitude" style="width:160px">
                <button id="addBtn" class="ok">Add Transport</button>
                <div style="flex:1"></div>
                <button id="refreshBtn">Refresh</button>
                <button id="clearAllBtn" class="danger">Clear All</button>
            </div>
            <div id="busList">
                <div class="empty">Loading transports...</div>
            </div>
        </div>

        <!-- BUILDINGS TAB -->
        <div id="buildings" class="tab-content">
            <div style="display:grid; grid-template-columns:1.2fr 1fr; gap:20px">
                <!-- MAP -->
                <div>
                    <div class="field-label" style="margin-bottom:8px"><span class="icon">üìç</span> Click to place building</div>
                    <div id="buildingsMap" style="height:500px; border-radius:8px; margin-bottom:16px; border:2px solid rgba(102,126,234,0.3)"></div>
                </div>

                <!-- CONTROLS -->
                <div>
                    <!-- HOSTELS -->
                    <div class="route-panel" style="margin-bottom:20px">
                        <h3 style="margin:0 0 12px 0; font-size:14px"><span class="icon">üè®</span> Add Hostel</h3>
                        <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:12px">
                            <input id="hostelName" placeholder="Name (e.g. Block A)" style="width:100%; font-size:12px; padding:6px 8px">
                            <input id="hostelCapacity" placeholder="Capacity" style="width:100%; font-size:12px; padding:6px 8px" value="100">
                            <button id="addHostelBtn" class="ok" style="background:rgba(52,211,153,0.1); font-size:12px; padding:6px">+ Place on Map</button>
                        </div>
                        <div class="field-label">Hostels (<span id="hostelCount">0</span>)</div>
                        <div id="hostelsList" style="max-height:200px; overflow-y:auto; background:#0d1117; border-radius:6px; padding:8px">
                            <div class="empty" style="font-size:12px; padding:10px">Click map to add</div>
                        </div>
                    </div>

                    <!-- CLASSES -->
                    <div class="route-panel">
                        <h3 style="margin:0 0 12px 0; font-size:14px"><span class="icon">üìö</span> Add Class</h3>
                        <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:12px">
                            <input id="className" placeholder="Name (e.g. A-101)" style="width:100%; font-size:12px; padding:6px 8px">
                            <input id="classDept" placeholder="Department" style="width:100%; font-size:12px; padding:6px 8px">
                            <button id="addClassBtn" class="ok" style="background:rgba(52,211,153,0.1); font-size:12px; padding:6px">+ Place on Map</button>
                        </div>
                        <div class="field-label">Classes (<span id="classCount">0</span>)</div>
                        <div id="classesList" style="max-height:200px; overflow-y:auto; background:#0d1117; border-radius:6px; padding:8px">
                            <div class="empty" style="font-size:12px; padding:10px">Click map to add</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let currentWaypoints = [];
        let currentStops = [];
        let editingRouteId = null;
        let routeMap = null;
        let routeMarkers = [];
        let mapMode = 'start'; // 'start' or 'stops'
        
        let buildingsMap = null;
        let buildingMarkers = {};
        let pendingHostelName = null;
        let pendingHostelCapacity = null;
        let pendingClassName = null;
        let pendingClassDept = null;

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.getAttribute('data-tab')).classList.add('active');
                if (tab.getAttribute('data-tab') === 'routes') {
                    setTimeout(initRouteMap, 100);
                    loadRoutes();
                    stopBusesAutoRefresh();
                } else if (tab.getAttribute('data-tab') === 'buildings') {
                    setTimeout(initBuildingsMap, 100);
                    loadHostels();
                    loadClasses();
                    stopBusesAutoRefresh();
                } else if (tab.getAttribute('data-tab') === 'buses') {
                    startBusesAutoRefresh();
                }
            });
        });

        // ==== ROUTE MAP ====
        function initRouteMap() {
            if (routeMap) return;
            const bounds = [[20.339920625677212, 85.7964659296332], [20.37210882553945, 85.83388810783698]];
            routeMap = L.map('routeMap', { maxBounds: bounds, minZoom: 14 }).setView([20.3549, 85.8161], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO',
                maxZoom: 19
            }).addTo(routeMap);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
                attribution: '',
                maxZoom: 19
            }).addTo(routeMap);

            routeMap.on('click', (e) => {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                addWaypointFromMap(lat, lng);
            });
        }

        function addWaypointFromMap(lat, lng) {
            if (mapMode === 'start' && currentWaypoints.length === 0) {
                // First point is START
                currentWaypoints.push([lat, lng]);
                currentStops.push('START');
                mapMode = 'stops';
                updateSteps();
                updateInstructions();
            } else if (mapMode === 'stops') {
                // Additional points are STOPS
                currentWaypoints.push([lat, lng]);
                const stopNum = currentWaypoints.length;
                currentStops.push(`Stop ${stopNum - 1}`);
            }
            renderMapWaypoints();
            renderStopsList();
        }

        function updateSteps() {
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('done');
            document.getElementById('step2').classList.add('active');
        }

        function updateInstructions() {
            const instructions = {
                start: {
                    main: 'üìç Step 1: Set START point',
                    sub: 'Click ONE spot on the map - this is where the transport starts'
                },
                stops: {
                    main: 'üõë Step 2: Add STOPS',
                    sub: `Click more spots for each stop. You have ${currentWaypoints.length - 1} stops. Add more or Save.`
                }
            };
            
            const inst = instructions[mapMode];
            document.getElementById('mainInstruction').textContent = inst.main;
            document.getElementById('subInstruction').textContent = inst.sub;
        }

        function renderMapWaypoints() {
            // Clear existing
            routeMarkers.forEach(m => {
                try { routeMap.removeLayer(m); } catch(e) {}
            });
            routeMarkers = [];

            const color = document.getElementById('routeColor').value;

            // Add markers (fixed-size DivIcons)
            currentWaypoints.forEach((wp, idx) => {
                const isStart = idx === 0;
                const bg = isStart ? '#4CAF50' : color;
                const html = isStart
                    ? '<span class="tiny-marker tiny-start"></span>'
                    : `<span class="tiny-marker" style="background:${bg}"></span>`;
                const icon = L.divIcon({ className: 'marker-wrapper', html: html, iconSize: [10,10], iconAnchor: [5,5] });
                const marker = L.marker([wp[0], wp[1]], { icon }).addTo(routeMap);
                const label = currentStops[idx] || (isStart ? 'START' : `Stop ${idx}`);
                marker.bindPopup(`<b>${label}</b><br>${wp[0].toFixed(4)}, ${wp[1].toFixed(4)}`);
                routeMarkers.push(marker);
            });

            // Draw polyline with road-based routing
            if (currentWaypoints.length > 1) {
                getOSRMRoute(currentWaypoints).then(routeCoords => {
                    const line = L.polyline(routeCoords || currentWaypoints, {
                        color: color,
                        weight: 2,
                        opacity: 0.7
                    }).addTo(routeMap);
                    routeMarkers.push(line);
                });
            }
        }

        async function getOSRMRoute(waypoints) {
            try {
                if (waypoints.length < 2) return waypoints;
                
                // Format: lon,lat;lon,lat...
                const coords = waypoints.map(wp => `${wp[1]},${wp[0]}`).join(';');
                const url = `https://router.project-osrm.org/route/v1/driving/${coords}?geometries=geojson`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.routes && data.routes[0]) {
                    // Convert GeoJSON coords (lon,lat) to Leaflet format (lat,lon)
                    return data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                }
                return waypoints;
            } catch(e) {
                console.error('OSRM error:', e);
                return waypoints;
            }
        }

        function renderStopsList() {
            const list = document.getElementById('stopsList');
            document.getElementById('stopCount').textContent = currentWaypoints.length;
            
            if (currentWaypoints.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#666; padding:20px; font-size:12px">No stops yet - click map to start</div>';
                return;
            }
            
            list.innerHTML = '';
            currentWaypoints.forEach((wp, idx) => {
                const item = document.createElement('div');
                const isStart = idx === 0;
                item.className = `stop-item ${isStart ? 'start' : ''}`;
                item.style.borderLeftColor = isStart ? '#4CAF50' : document.getElementById('routeColor').value;
                
                item.innerHTML = `
                    <div class="stop-icon">${isStart ? 'üü¢' : 'üî¥'}</div>
                    <input type="text" placeholder="${isStart ? 'START' : 'Stop name'}" value="${currentStops[idx]}" readonly style="cursor:pointer" title="Click to edit">
                    <button class="danger" style="padding:4px 6px; font-size:11px" onclick="removeMapWaypoint(${idx})">‚úï</button>
                `;
                
                const input = item.querySelector('input');
                input.addEventListener('click', () => {
                    input.removeAttribute('readonly');
                    input.style.cursor = 'text';
                    input.focus();
                });
                input.addEventListener('blur', () => {
                    currentStops[idx] = input.value || (isStart ? 'START' : `Stop ${idx}`);
                    input.setAttribute('readonly', '');
                    input.style.cursor = 'pointer';
                    renderMapWaypoints();
                });
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') input.blur();
                });
                
                list.appendChild(item);
            });
        }

        window.removeMapWaypoint = (idx) => {
            if (idx === 0 && currentWaypoints.length > 1) {
                alert('Cannot remove START point');
                return;
            }
            currentWaypoints.splice(idx, 1);
            currentStops.splice(idx, 1);
            if (currentWaypoints.length === 0) mapMode = 'start';
            updateSteps();
            updateInstructions();
            renderMapWaypoints();
            renderStopsList();
        };

        document.getElementById('clearMapBtn').addEventListener('click', () => {
            if (currentWaypoints.length > 0 && !confirm('Clear all stops?')) return;
            currentWaypoints = [];
            currentStops = [];
            mapMode = 'start';
            document.getElementById('step1').classList.remove('done');
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.remove('active');
            renderMapWaypoints();
            renderStopsList();
            updateInstructions();
        });

        document.getElementById('routeColor').addEventListener('change', () => {
            renderMapWaypoints();
        });

        document.getElementById('saveRouteBtn').addEventListener('click', async () => {
            const name = document.getElementById('routeName').value.trim();
            const color = document.getElementById('routeColor').value;
            
            if (!name) { alert('Enter route name'); return; }
            if (currentWaypoints.length < 2) { alert('Add at least START + 1 STOP'); return; }
            
            const route = {
                id: editingRouteId || `route_${Date.now()}`,
                name: name,
                waypoints: currentWaypoints,
                stops: currentStops,
                color: color
            };
            
            const res = await fetch('/api/route', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(route)
            });
            
            if (res.ok) {
                currentWaypoints = [];
                currentStops = [];
                editingRouteId = null;
                mapMode = 'start';
                document.getElementById('routeName').value = '';
                document.getElementById('step1').classList.remove('done');
                document.getElementById('step1').classList.add('active');
                document.getElementById('step2').classList.remove('active');
                renderMapWaypoints();
                renderStopsList();
                updateInstructions();
                await loadRoutes();
            }
        });

        async function loadRoutes() {
            const [routesRes, busRoutesRes] = await Promise.all([
                fetch('/api/routes'),
                fetch('/api/bus-routes')
            ]);
            const routes = await routesRes.json();
            const busRoutes = await busRoutesRes.json();
            renderRoutes(routes, busRoutes);
        }

        function renderRoutes(routes, busRoutes) {
            const container = document.getElementById('routesList');
            if (routes.length === 0) {
                container.innerHTML = '<div class="empty">No routes yet - create one!</div>';
                return;
            }
            container.innerHTML = '';
            routes.forEach(route => {
                // Determine status: running if any active bus is assigned to this route
                const isRunning = Object.values(busRoutes || {}).some(rid => String(rid) === String(route.id));
                const card = document.createElement('div');
                card.className = 'route-card';
                card.style.borderLeftColor = route.color;
                card.innerHTML = `
                    <div class="route-name">${route.name}</div>
                    <div class="route-info">
                        <div>üõë ${route.waypoints.length} stops</div>
                        <div style="margin-top:4px"><span class="route-badge ${isRunning ? 'badge-running' : 'badge-idle'}">${isRunning ? 'Running' : 'Idle'}</span></div>
                        <div style="margin-top:4px; color:#667eea">${(route.stops || []).slice(0, 2).join(' ‚Üí ')}</div>
                    </div>
                    <div class="route-actions">
                        <button class="ok" style="background:rgba(102,126,234,0.1)" onclick="editRoute('${route.id}')">‚úèÔ∏è Edit</button>
                        <button class="danger" style="background:rgba(255,123,138,0.05)" onclick="deleteRoute('${route.id}')">üóëÔ∏è Delete</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        window.editRoute = async (routeId) => {
            const res = await fetch('/api/routes');
            const routes = await res.json();
            const route = routes.find(r => r.id === routeId);
            if (route) {
                document.querySelector('[data-tab="routes"]').click();
                setTimeout(() => {
                    document.getElementById('routeName').value = route.name;
                    document.getElementById('routeColor').value = route.color;
                    currentWaypoints = JSON.parse(JSON.stringify(route.waypoints));
                    currentStops = JSON.parse(JSON.stringify(route.stops || []));
                    editingRouteId = routeId;
                    mapMode = 'stops';
                    updateSteps();
                    updateInstructions();
                    renderMapWaypoints();
                    renderStopsList();
                    window.scrollTo(0, 0);
                }, 200);
            }
        };

        window.deleteRoute = async (routeId) => {
            await fetch(`/api/route/${routeId}`, { method: 'DELETE' });
            await loadRoutes();
        };

        // ==== BUSES ====
        async function loadBuses() {
            const res = await fetch('/api/buses');
            const buses = await res.json();
            renderBuses(buses);
        }

        function renderBuses(buses) {
            const keys = Object.keys(buses).sort((a,b) => parseInt(a)-parseInt(b));
            const container = document.getElementById('busList');
            if (keys.length === 0) {
                container.innerHTML = '<div class="empty">No active transports</div>';
                return;
            }
            // Build table once if not present, else update rows incrementally
            let table = container.querySelector('table');
            if(!table){
                container.innerHTML = '<table><thead><tr><th>Transport</th><th>Latitude</th><th>Longitude</th><th>Last Update</th><th></th></tr></thead><tbody></tbody></table>';
                table = container.querySelector('table');
            }
            const tbody = table.querySelector('tbody');
            const existingRows = new Set(Array.from(tbody.querySelectorAll('tr')).map(r=>r.getAttribute('data-bus')));
            // Add or update rows
            keys.forEach(k=>{
                const b = buses[k];
                let row = tbody.querySelector(`tr[data-bus="${k}"]`);
                if(!row){
                    row = document.createElement('tr');
                    row.setAttribute('data-bus', k);
                    row.innerHTML = `
                        <td><strong>Transport ${k}</strong></td>
                        <td><input class="lat" value="${b.lat}" style="width:140px"></td>
                        <td><input class="lng" value="${b.lng}" style="width:140px"></td>
                        <td class="small muted">${b.lastUpdate || ''}</td>
                        <td class="row-actions"><button class="save ok">Save</button><button class="remove danger">Remove</button></td>
                    `;
                    tbody.appendChild(row);
                    row.querySelector('.save').addEventListener('click', onSaveBus);
                    row.querySelector('.remove').addEventListener('click', onRemoveBus);
                } else {
                    // Skip update if user is editing inputs in this row
                    const activeEl = document.activeElement;
                    if(!(activeEl && row.contains(activeEl))){
                        const latInput = row.querySelector('.lat');
                        const lngInput = row.querySelector('.lng');
                        const lastCell = row.querySelector('.small.muted');
                        if(latInput && String(latInput.value) !== String(b.lat)) latInput.value = b.lat;
                        if(lngInput && String(lngInput.value) !== String(b.lng)) lngInput.value = b.lng;
                        if(lastCell && lastCell.textContent !== (b.lastUpdate||'')) lastCell.textContent = b.lastUpdate || '';
                    }
                }
                existingRows.delete(k);
            });
            // Remove rows for buses no longer present
            existingRows.forEach(k=>{
                const row = tbody.querySelector(`tr[data-bus="${k}"]`);
                if(row){ try{ row.remove(); }catch(e){} }
            });
            // Empty state
            if(tbody.children.length===0){ container.innerHTML = '<div class="empty">No active transports</div>'; }
        }

        async function onSaveBus(e) {
            const row = e.target.closest('tr');
            const busNum = row.getAttribute('data-bus');
            const lat = parseFloat(row.querySelector('.lat').value);
            const lng = parseFloat(row.querySelector('.lng').value);
            if (isNaN(lat) || isNaN(lng)) { alert('Enter valid coordinates'); return; }
            await fetch(`/api/bus/${busNum}`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ lat: lat, lng: lng, lastUpdate: new Date().toISOString() })
            });
            await loadBuses();
        }

        async function onRemoveBus(e) {
            const row = e.target.closest('tr');
            const busNum = row.getAttribute('data-bus');
            await fetch(`/api/bus/${busNum}`, { method: 'DELETE' });
            await loadBuses();
        }

        document.getElementById('refreshBtn').addEventListener('click', loadBuses);
        document.getElementById('clearAllBtn').addEventListener('click', async () => {
            if (!confirm('Clear all transports?')) return;
            await fetch('/api/buses/clear', { method: 'POST' });
            await loadBuses();
        });
        document.getElementById('addBtn').addEventListener('click', async () => {
            const num = document.getElementById('newBusNum').value.trim();
            const lat = parseFloat(document.getElementById('newLat').value);
            const lng = parseFloat(document.getElementById('newLng').value);
            if (!num || isNaN(lat) || isNaN(lng)) { alert('Provide transport number and coords'); return; }
            await fetch(`/api/bus/${num}`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ lat: lat, lng: lng, lastUpdate: new Date().toISOString() })
            });
            document.getElementById('newBusNum').value='';
            document.getElementById('newLat').value='';
            document.getElementById('newLng').value='';
            await loadBuses();
        });

        // Auto-refresh for transports list
        let busesAutoRefreshId = null;
        let isBusesRefreshing = false;
        function startBusesAutoRefresh(){
            stopBusesAutoRefresh();
            busesAutoRefreshId = setInterval(async ()=>{
                const busesTab = document.getElementById('buses');
                const busListEl = document.getElementById('busList');
                if(!busesTab || !busesTab.classList.contains('active')) return;
                if(document.hidden) return;
                if(isBusesRefreshing) return;
                const activeEl = document.activeElement;
                if(activeEl && busListEl && busListEl.contains(activeEl) && (activeEl.tagName==='INPUT' || activeEl.tagName==='BUTTON')) return;
                try{
                    isBusesRefreshing = true;
                    // Soft refresh via incremental update
                    const res = await fetch('/api/buses');
                    const buses = await res.json();
                    renderBuses(buses);
                } finally { isBusesRefreshing = false; }
            }, 3000);
        }
        function stopBusesAutoRefresh(){
            if(busesAutoRefreshId){ try{ clearInterval(busesAutoRefreshId); }catch(e){} busesAutoRefreshId = null; }
        }

        // Initial load and start auto refresh (buses tab is active by default)
        loadBuses();
        startBusesAutoRefresh();

        // Live updates via SSE
        try{
            const es = new EventSource('/events');
            es.onmessage = (ev)=>{
                try{
                    const msg = JSON.parse(ev.data);
                    if(msg.type === 'bus_update'){
                        const k = msg.bus; const b = msg.data||{};
                        const table = document.getElementById('busList').querySelector('table');
                        if(table){ renderBuses({ [k]: b }); }
                    } else if(msg.type === 'bus_stop'){
                        const row = document.querySelector(`#busList tr[data-bus="${msg.bus}"]`);
                        if(row) row.remove();
                    } else if(msg.type === 'buses_clear'){
                        document.getElementById('busList').innerHTML = '<div class="empty">No active transports</div>';
                    }
                }catch(e){ /* ignore */ }
            };
        }catch(e){ /* SSE not available, fallback to polling only */ }

        // ==== BUILDINGS MAP ====
        function initBuildingsMap() {
            if (buildingsMap) return;
            const bounds = [[20.339920625677212, 85.7964659296332], [20.37210882553945, 85.83388810783698]];
            buildingsMap = L.map('buildingsMap', { maxBounds: bounds, minZoom: 14 }).setView([20.3549, 85.8161], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO',
                maxZoom: 19
            }).addTo(buildingsMap);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
                attribution: '',
                maxZoom: 19
            }).addTo(buildingsMap);

            buildingsMap.on('click', (e) => {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                if (pendingHostelName) {
                    addHostelToMap(lat, lng);
                } else if (pendingClassName) {
                    addClassToMap(lat, lng);
                }
            });
            
            renderBuildingMarkers();
        }

        async function addHostelToMap(lat, lng) {
            const name = pendingHostelName;
            const capacity = pendingHostelCapacity || 100;
            
            const res = await fetch('/api/hostel', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ name, lat, lng, capacity: parseInt(capacity) })
            });
            
            if (res.ok) {
                document.getElementById('hostelName').value = '';
                document.getElementById('hostelCapacity').value = '100';
                pendingHostelName = null;
                pendingHostelCapacity = null;
                document.getElementById('addHostelBtn').textContent = '+ Place on Map';
                document.getElementById('addHostelBtn').style.background = 'rgba(52,211,153,0.1)';
                await loadHostels();
            }
        }

        async function addClassToMap(lat, lng) {
            const name = pendingClassName;
            const department = pendingClassDept || 'Unknown';
            
            const res = await fetch('/api/class', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ name, lat, lng, department })
            });
            
            if (res.ok) {
                document.getElementById('className').value = '';
                document.getElementById('classDept').value = '';
                pendingClassName = null;
                pendingClassDept = null;
                document.getElementById('addClassBtn').textContent = '+ Place on Map';
                document.getElementById('addClassBtn').style.background = 'rgba(52,211,153,0.1)';
                await loadClasses();
            }
        }

        async function loadHostels() {
            try {
                const res = await fetch('/api/hostels');
                const hostels = await res.json();
                document.getElementById('hostelCount').textContent = hostels.length;
                renderHostelsList(hostels);
            } catch(e) { console.error(e); }
        }

        async function loadClasses() {
            try {
                const res = await fetch('/api/classes');
                const classes = await res.json();
                document.getElementById('classCount').textContent = classes.length;
                renderClassesList(classes);
            } catch(e) { console.error(e); }
        }

        function renderHostelsList(hostels) {
            const container = document.getElementById('hostelsList');
            if (hostels.length === 0) {
                container.innerHTML = '<div class="empty" style="font-size:12px; padding:10px">No hostels yet</div>';
                return;
            }
            
            container.innerHTML = hostels.map(h => `
                <div style="padding:8px; background:#07101a; border-radius:4px; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center; font-size:12px">
                    <div>
                        <div style="font-weight:600">${h.name}</div>
                        <div style="color:#9aa4b2; font-size:11px">${h.capacity} capacity</div>
                    </div>
                    <button onclick="deleteHostel('${h.id}')" style="background:#ff5722; color:white; border:none; padding:4px 8px; border-radius:3px; cursor:pointer; font-size:11px">‚úï</button>
                </div>
            `).join('');
        }

        function renderClassesList(classes) {
            const container = document.getElementById('classesList');
            if (classes.length === 0) {
                container.innerHTML = '<div class="empty" style="font-size:12px; padding:10px">No classes yet</div>';
                return;
            }
            
            container.innerHTML = classes.map(c => `
                <div style="padding:8px; background:#07101a; border-radius:4px; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center; font-size:12px">
                    <div>
                        <div style="font-weight:600">${c.name}</div>
                        <div style="color:#9aa4b2; font-size:11px">${c.department}</div>
                    </div>
                    <button onclick="deleteClass('${c.id}')" style="background:#ff5722; color:white; border:none; padding:4px 8px; border-radius:3px; cursor:pointer; font-size:11px">‚úï</button>
                </div>
            `).join('');
        }

        function renderBuildingMarkers() {
            if (!buildingsMap) return;
            
            Object.values(buildingMarkers).forEach(m => {
                try { buildingsMap.removeLayer(m); } catch(e) {}
            });
            buildingMarkers = {};
            
            fetch('/api/hostels').then(r => r.json()).then(hostels => {
                hostels.forEach(h => {
                    const icon = L.divIcon({ className: 'marker-wrapper', html: '<span class="tiny-marker tiny-hostel"></span>', iconSize:[10,10], iconAnchor:[5,5] });
                    const marker = L.marker([h.lat, h.lng], { icon }).bindPopup(`<b>${h.name}</b><br/>Capacity: ${h.capacity}`).addTo(buildingsMap);
                    buildingMarkers[h.id] = marker;
                });
            });
            
            fetch('/api/classes').then(r => r.json()).then(classes => {
                classes.forEach(c => {
                    const icon = L.divIcon({ className: 'marker-wrapper', html: '<span class="tiny-marker tiny-class"></span>', iconSize:[10,10], iconAnchor:[5,5] });
                    const marker = L.marker([c.lat, c.lng], { icon }).bindPopup(`<b>${c.name}</b><br/>${c.department}`).addTo(buildingsMap);
                    buildingMarkers[c.id] = marker;
                });
            });
        }

        async function deleteHostel(id) {
            await fetch(`/api/hostel/${id}`, { method: 'DELETE' });
            await loadHostels();
            renderBuildingMarkers();
        }

        async function deleteClass(id) {
            await fetch(`/api/class/${id}`, { method: 'DELETE' });
            await loadClasses();
            renderBuildingMarkers();
        }

        document.getElementById('addHostelBtn').addEventListener('click', () => {
            const name = document.getElementById('hostelName').value.trim();
            if (!name) { alert('Enter hostel name'); return; }
            pendingHostelName = name;
            pendingHostelCapacity = document.getElementById('hostelCapacity').value;
            document.getElementById('addHostelBtn').textContent = 'üìç Click on map...';
            document.getElementById('addHostelBtn').style.background = 'rgba(102,126,234,0.2)';
            setTimeout(initBuildingsMap, 100);
        });

        document.getElementById('addClassBtn').addEventListener('click', () => {
            const name = document.getElementById('className').value.trim();
            if (!name) { alert('Enter class name'); return; }
            pendingClassName = name;
            pendingClassDept = document.getElementById('classDept').value;
            document.getElementById('addClassBtn').textContent = 'üìç Click on map...';
            document.getElementById('addClassBtn').style.background = 'rgba(102,126,234,0.2)';
            setTimeout(initBuildingsMap, 100);
        });
    </script>
</body>
</html>
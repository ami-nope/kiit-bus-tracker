<!DOCTYPE html>
<html>
<head>
    <title>Bus Tracker - Student View</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Minimal, nonchalant dark theme */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #07070a;
            color: #e6eef8;
            min-height: 100vh;
        }

        .header {
            background: transparent;
            padding: 18px 12px;
            text-align: left;
        }
        .header h1 { font-size: 20px; color: #e6eef8; margin-bottom: 4px; }
        .header p { color: #9aa4b2; font-size: 13px; margin-top: 2px }
        /* Unified icon styling */
        .icon { display:inline-block; font-size:16px; line-height:1; vertical-align:middle; opacity:0.9; margin-right:6px }
        /* Map tiny markers (fixed pixel size) */
        .tiny-marker { width:8px; height:8px; border-radius:50%; display:inline-block; border:1px solid rgba(255,255,255,0.6); box-shadow:0 0 0 1px rgba(0,0,0,0.25); transition: transform 120ms ease; transform-origin:center }
        .tiny-marker:hover { transform: scale(1.25); }
        .tiny-hostel { background:#9C27B0 }
        .tiny-class { background:#2196F3 }
        .marker-wrapper { width:10px; height:10px }
        .leaflet-div-icon { background: transparent !important; border: none !important; }

        .main-container { display:flex; gap:18px; max-width:1200px; margin: 12px auto; padding: 0 12px; }
        .sidebar { flex:1; min-width:260px; max-width:380px; }
        .map-container { flex:1.5; min-height:0; }

        /* Smaller map like admin, with white border */
        #map {
            height: 500px;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.95);
            box-shadow: none;
            background: #05060a;
        }

        .card {
            background: rgba(255,255,255,0.02);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 14px;
            border: 1px solid rgba(255,255,255,0.04);
        }
        .card h3 { color: #dbeafe; font-size:15px; margin-bottom:10px }

        .route-item, .bus-item, .toggle-item, .stat-box { background: transparent; border-radius:8px; }
        .route-item { padding:10px; border-left:4px solid; font-size:13px }
        .route-item.active { background: rgba(255,255,255,0.02) }

        .empty-state { color: #7c8898; padding:24px; }

        .stat-number { font-size:24px; color:#cbd5e1 }

        @media (max-width: 968px) {
            .main-container { flex-direction:column; padding:12px }
            .map-container { order: 2 }
            .sidebar { order: 1 }
            #map { height: 420px }
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <div class="header">
        <h1><span class="icon">üöç</span>{{ institute_name | default('INSTITUTE') }} TRANSPORT SYSTEM</h1>
        <p>Real-time bus locations across all campuses</p>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="card">
                <h3>
                    <span class="icon">üìä</span>
                    Live Statistics
                </h3>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-number" id="busCount">0</div>
                        <div class="stat-label">Active Buses</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">20</div>
                        <div class="stat-label">Total Fleet</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>
                    <span class="icon">üéØ</span>
                    Track Bus
                </h3>
                <div style="display:flex;gap:10px;align-items:center;">
                    <select id="trackBusSelect" style="flex:1;padding:10px;border-radius:8px;border:1px solid #2a2a3e;background:#0f0f23;color:#fff">
                        <option value="">‚Äî Select bus to follow ‚Äî</option>
                    </select>
                    <label style="display:flex;align-items:center;gap:6px;color:#9aa;white-space:nowrap">
                        <input type="checkbox" id="followCheckbox" checked style="width:16px;height:16px"> Follow
                    </label>
                </div>
            </div>

            <div class="card">
                <h3>
                    <span>üìç</span>
                    Map Layers
                </h3>
                <div class="layer-control">
                    <label class="toggle-item">
                        <input type="checkbox" id="routesToggle" checked>
                        <span class="toggle-label">Routes</span>
                        <span class="layer-icon" style="background: #FF5722;"></span>
                    </label>
                    <label class="toggle-item">
                        <input type="checkbox" id="hostelsToggle" checked>
                        <span class="toggle-label">Hostels</span>
                        <span class="layer-icon" style="background: #9C27B0;"></span>
                    </label>
                    <label class="toggle-item">
                        <input type="checkbox" id="classesToggle" checked>
                        <span class="toggle-label">Classes</span>
                        <span class="layer-icon" style="background: #2196F3;"></span>
                    </label>
                </div>
            </div>

            <div class="card">
                <h3>
                    <span>üõ£Ô∏è</span>
                    Routes
                </h3>
                <div class="route-selector" id="routesContainer"></div>
            </div>

            <div class="card" id="routeDetailsCard" style="display:none">
                <h3>
                    <span>üìç</span>
                    Route Details
                </h3>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
                    <div style="text-align:center">
                        <div style="font-size:12px; color:#9aa4b2">ETA</div>
                        <div id="etaValue" style="font-size:18px; font-weight:600; color:#34d399; margin-top:4px">--</div>
                    </div>
                    <div style="text-align:center">
                        <div style="font-size:12px; color:#9aa4b2">Walk Distance</div>
                        <div id="walkDistance" style="font-size:18px; font-weight:600; color:#667eea; margin-top:4px">--</div>
                    </div>
                </div>
                <div id="busesOnRoute" style="margin-top:12px; font-size:12px; color:#9aa4b2">
                    <span>üöå Buses on route: <span id="busCount">-</span></span>
                </div>
            </div>

            <div class="card">
                <h3>
                    <span>üöç</span>
                    Active Buses
                </h3>
                <div class="active-buses" id="activeBuses">
                    <div class="empty-state">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                            <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z"/>
                        </svg>
                        <p>No buses currently active</p>
                    </div>
                </div>
                <div class="last-update">
                    Last updated: <span id="lastUpdate">Loading...</span>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script>
        let map;
        let busMarkers = {};
        let hostelMarkers = {};
        let classMarkers = {};
        let routePolylines = {};
        let selectedRouteId = null;
        let allRoutes = [];
        let userLocation = null;
        let walkingLine = null;
        let busRouteMap = {}; // Maps bus number to route ID
        const colors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
            '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B739', '#52B788',
            '#E76F51', '#2A9D8F', '#E9C46A', '#F4A261', '#264653',
            '#E63946', '#A8DADC', '#457B9D', '#1D3557', '#F1FAEE'
        ];

        let prevBusPositions = {};
        
        // Get user location on load
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                userLocation = [pos.coords.latitude, pos.coords.longitude];
                console.log('User location:', userLocation);
            }, (err) => console.log('Geolocation error:', err));
        }
        
        // Load bus routes mapping
        async function loadBusRoutes() {
            try {
                const res = await fetch('/api/bus-routes');
                busRouteMap = await res.json();
            } catch(e) {
                console.error('Error loading bus routes:', e);
            }
        }
        
        function calcDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c * 1000; // meters
        }
        
        function calcBearing(from, to) {
            const rad = Math.atan2(to[1] - from[1], to[0] - from[0]);
            return (rad * 180 / Math.PI + 90) % 360;
        }
        
        function createIcon(busNum, color, size = 50, rotation = 0) {
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            
            ctx.save();
            ctx.translate(size/2, size/2);
            ctx.rotate(rotation * Math.PI / 180);
            ctx.translate(-size/2, -size/2);

            ctx.fillStyle = color;
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(size/2, size/2 - size/8, Math.max(12, size/2 - 7), 0, 2 * Math.PI);
            ctx.fill();
            ctx.stroke();
            
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(size/2, size/2 + size/6);
            ctx.lineTo(size/2 - size/6, size/2 - size/8);
            ctx.lineTo(size/2 + size/6, size/2 - size/8);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            ctx.fillStyle = 'white';
            ctx.font = `bold ${Math.max(10, Math.round(size/4))}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(busNum, size/2, size/2 - size/8);
            
            ctx.restore();

            return L.icon({
                iconUrl: canvas.toDataURL(),
                iconSize: [size, size],
                iconAnchor: [Math.round(size/2), Math.round(size/2)]
            });
        }

        function createLocationIcon(type) {
            const html = type === 'hostel'
                ? '<span class="tiny-marker tiny-hostel"></span>'
                : '<span class="tiny-marker tiny-class"></span>';
            return L.divIcon({ className: 'marker-wrapper', html, iconSize: [10,10], iconAnchor: [5,5], popupAnchor: [0, -8] });
        }

        let trackedBus = null;
        let followEnabled = true;
        let visibleLayers = {
            routes: true,
            hostels: true,
            classes: true
        };

        function updateLayerVisibility(layer, visible) {
            visibleLayers[layer] = visible;
            
            if (layer === 'hostels') {
                Object.values(hostelMarkers).forEach(m => {
                    if (visible) map.addLayer(m);
                    else map.removeLayer(m);
                });
            } else if (layer === 'classes') {
                Object.values(classMarkers).forEach(m => {
                    if (visible) map.addLayer(m);
                    else map.removeLayer(m);
                });
            } else if (layer === 'routes') {
                Object.values(routePolylines).forEach(p => {
                    if (visible) map.addLayer(p);
                    else map.removeLayer(p);
                });
            }
        }

        function loadHostels() {
            fetch('/api/hostels')
                .then(r => r.json())
                .then(hostels => {
                    // Clear existing
                    Object.values(hostelMarkers).forEach(m => map.removeLayer(m));
                    hostelMarkers = {};

                    hostels.forEach(hostel => {
                        const marker = L.marker([hostel.lat, hostel.lng], {
                            icon: createLocationIcon('hostel'),
                            title: hostel.name
                        }).addTo(map);
                        marker.bindPopup(`<b>${hostel.name}</b><br>Capacity: ${hostel.capacity}`);
                        hostelMarkers[hostel.id] = marker;
                        if (!visibleLayers.hostels) map.removeLayer(marker);
                    });
                })
                .catch(e => console.error('Error loading hostels:', e));
        }

        function loadClasses() {
            fetch('/api/classes')
                .then(r => r.json())
                .then(classes => {
                    // Clear existing
                    Object.values(classMarkers).forEach(m => map.removeLayer(m));
                    classMarkers = {};

                    classes.forEach(cls => {
                        const marker = L.marker([cls.lat, cls.lng], {
                            icon: createLocationIcon('class'),
                            title: cls.name
                        }).addTo(map);
                        marker.bindPopup(`<b>${cls.name}</b><br>Dept: ${cls.department}`);
                        classMarkers[cls.id] = marker;
                        if (!visibleLayers.classes) map.removeLayer(marker);
                    });
                })
                .catch(e => console.error('Error loading classes:', e));
        }

        function loadRoutes() {
            fetch('/api/routes')
                .then(r => r.json())
                .then(routes => {
                    // Clear existing
                    Object.values(routePolylines).forEach(p => map.removeLayer(p));
                    routePolylines = {};
                    allRoutes = routes;

                    routes.forEach(route => {
                        // Get road-based route from OSRM
                        getOSRMRoute(route.waypoints).then(routeCoords => {
                            const polyline = L.polyline(routeCoords || route.waypoints, {
                                color: route.color,
                                weight: 4,
                                opacity: 0.8,
                                dashArray: '5, 5'
                            }).addTo(map);
                            
                            // Create popup with all stops
                            const stopsText = (route.stops || []).map((s, i) => {
                                const wp = route.waypoints[i];
                                return `${s} (${wp[0].toFixed(4)}, ${wp[1].toFixed(4)})`;
                            }).join('<br>');
                            
                            polyline.bindPopup(`<b>${route.name}</b><br><small>${stopsText || route.waypoints.map(wp => wp.join(',')).join('<br>')}</small>`);
                            polyline.on('click', () => selectRoute(route.id));
                            
                            // Add stop markers with tooltips
                            route.waypoints.forEach((wp, idx) => {
                                const stopName = (route.stops && route.stops[idx]) || `Stop ${idx + 1}`;
                                const icon = L.divIcon({ className: 'marker-wrapper', html: `<span class="tiny-marker" style="background:${route.color}"></span>`, iconSize:[10,10], iconAnchor:[5,5] });
                                const marker = L.marker([wp[0], wp[1]], { icon }).addTo(map);
                                
                                marker.bindTooltip(stopName, {
                                    permanent: false,
                                    direction: 'top',
                                    offset: [0, -8],
                                    className: 'stop-tooltip'
                                });
                                marker.on('click', () => selectRoute(route.id));
                                
                                routePolylines[`${route.id}-stop-${idx}`] = marker;
                            });
                            
                            routePolylines[route.id] = polyline;
                            if (!visibleLayers.routes) map.removeLayer(polyline);
                        });
                    });
                    
                    renderRoutesList(routes);
                })
                .catch(e => console.error('Error loading routes:', e));
        }
        
        async function getOSRMRoute(waypoints) {
            try {
                if (waypoints.length < 2) return waypoints;
                
                // Format: lon,lat;lon,lat...
                const coords = waypoints.map(wp => `${wp[1]},${wp[0]}`).join(';');
                const url = `https://router.project-osrm.org/route/v1/driving/${coords}?geometries=geojson`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.routes && data.routes[0]) {
                    // Convert GeoJSON coords (lon,lat) to Leaflet format (lat,lon)
                    return data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                }
                return waypoints;
            } catch(e) {
                console.error('OSRM error:', e);
                return waypoints;
            }
        }

        // Returns {distance: meters, duration: seconds} between two points using OSRM
        async function getOSRMDuration(fromLatLng, toLatLng) {
            try {
                const coords = `${fromLatLng[1]},${fromLatLng[0]};${toLatLng[1]},${toLatLng[0]}`;
                const url = `https://router.project-osrm.org/route/v1/driving/${coords}?overview=false`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.routes && data.routes[0]) {
                    return { distance: data.routes[0].distance, duration: data.routes[0].duration };
                }
            } catch (e) {
                console.error('OSRM duration error:', e);
            }
            return null;
        }

        function renderRoutesList(routes) {
            const container = document.getElementById('routesContainer');
            if (routes.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#666; font-size:12px">No routes available</div>';
                return;
            }
            container.innerHTML = '';
            routes.forEach(route => {
                const item = document.createElement('div');
                item.className = `route-item ${selectedRouteId === route.id ? 'active' : ''}`;
                item.style.borderLeftColor = route.color;
                item.innerHTML = `<strong>${route.name}</strong><br><span style="color:#9aa; font-size:12px">${route.waypoints.length} stops</span>`;
                item.addEventListener('click', () => selectRoute(route.id));
                container.appendChild(item);
            });
        }

        function selectRoute(routeId) {
            selectedRouteId = selectedRouteId === routeId ? null : routeId;
            
            // Update UI
            document.querySelectorAll('.route-item').forEach(item => {
                item.classList.remove('active');
            });
            if (selectedRouteId) {
                const route = allRoutes.find(r => r.id === routeId);
                const index = Array.from(document.getElementById('routesContainer').children).findIndex(
                    child => child.innerText.includes(route.name)
                );
                if (index >= 0) {
                    document.querySelectorAll('.route-item')[index].classList.add('active');
                }
                
                // Show route details card
                showRouteDetails(route);
            } else {
                // Hide route details card
                document.getElementById('routeDetailsCard').style.display = 'none';
                if (walkingLine) {
                    map.removeLayer(walkingLine);
                    walkingLine = null;
                }
            }
            
            // Update map visibility
            Object.entries(routePolylines).forEach(([id, polyline]) => {
                if (!id.includes('-stop-')) {
                    try {
                        const opacity = selectedRouteId === id ? 1 : 0.3;
                        polyline.setStyle({ opacity: opacity });
                    } catch(e) {}
                }
            });
            
            renderRoutesList(allRoutes);
        }
        
        async function showRouteDetails(route) {
            const card = document.getElementById('routeDetailsCard');
            card.style.display = 'block';

            // Find buses on this route
            const busesOnRoute = Object.entries(busRouteMap)
                .filter(([bus, routeId]) => routeId === route.id)
                .map(([bus]) => bus);

            document.getElementById('busCount').textContent = busesOnRoute.length;

            let nearestStop = null;
            let nearestStopIndex = 0;
            let minDist = Infinity;

            if (userLocation && route.waypoints.length > 0) {
                // Find nearest bus stop
                route.waypoints.forEach((stop, idx) => {
                    const dist = calcDistance(userLocation[0], userLocation[1], stop[0], stop[1]);
                    if (dist < minDist) {
                        minDist = dist;
                        nearestStop = stop;
                        nearestStopIndex = idx;
                    }
                });

                if (nearestStop) {
                    // Show walking distance
                    const distKm = (minDist / 1000).toFixed(2);
                    const walkMin = Math.ceil(minDist / 1.4); // ~1.4 m/s walking speed
                    document.getElementById('walkDistance').textContent = `${distKm} km (${walkMin}m)`;

                    // Draw walking line
                    if (walkingLine) map.removeLayer(walkingLine);
                    walkingLine = L.polyline([userLocation, nearestStop], {
                        color: '#999999',
                        weight: 2,
                        opacity: 0.6,
                        dashArray: '5, 5'
                    }).addTo(map);
                }
            } else {
                document.getElementById('walkDistance').textContent = '--';
            }

            // Compute ETA using OSRM from each bus on route to the nearest stop
            let etaText = '--';
            if (busesOnRoute.length > 0 && nearestStop) {
                try {
                    const busesData = await fetch('/api/buses').then(r => r.json()).catch(() => ({}));
                    let minDuration = Infinity;

                    for (const busNum of busesOnRoute) {
                        const b = busesData[busNum];
                        if (!b || !b.lat || !b.lng) continue;
                        const durationObj = await getOSRMDuration([b.lat, b.lng], nearestStop);
                        if (durationObj && typeof durationObj.duration === 'number') {
                            if (durationObj.duration < minDuration) minDuration = durationObj.duration;
                        }
                    }

                    if (minDuration !== Infinity) {
                        const mins = Math.ceil(minDuration / 60);
                        etaText = `${mins}m`;
                    } else {
                        // fallback to route length estimate
                        const avgBusSpeed = 10; // km/h
                        const routeLength = estimateRouteDistance(route.waypoints);
                        const etaMinutes = Math.ceil(routeLength / avgBusSpeed * 60);
                        etaText = etaMinutes > 0 ? `${etaMinutes}m` : '--';
                    }
                } catch (e) {
                    console.error('Error computing OSRM ETA:', e);
                    etaText = '--';
                }
            } else {
                etaText = '--';
            }

            document.getElementById('etaValue').textContent = etaText;
        }
        
        function estimateRouteDistance(waypoints) {
            let total = 0;
            for (let i = 0; i < waypoints.length - 1; i++) {
                total += calcDistance(waypoints[i][0], waypoints[i][1], waypoints[i+1][0], waypoints[i+1][1]);
            }
            return total / 1000; // km
        }

        function setTrackedBus(busNum) {
            trackedBus = busNum || null;
            const select = document.getElementById('trackBusSelect');
            if (select.value !== (busNum || '')) select.value = busNum || '';
            // update marker visuals
            Object.keys(busMarkers).forEach(num => {
                const marker = busMarkers[num];
                const isTracked = trackedBus && num === trackedBus;
                // fade others
                try { marker.setOpacity(isTracked ? 1 : 0.2); } catch(e) {}
                // change size for tracked
                const color = colors[(parseInt(num) - 1) % colors.length];
                const newIcon = createIcon(num, color, isTracked ? 70 : 40);
                marker.setIcon(newIcon);
            });
        }

        function initMap() {
            const bounds = [[20.339920625677212, 85.7964659296332], [20.37210882553945, 85.83388810783698]];
            map = L.map('map', { zoomControl: true, maxBounds: bounds, minZoom: 14 }).setView([20.3549, 85.8161], 15);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO',
                maxZoom: 19
            }).addTo(map);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
                attribution: '',
                maxZoom: 19
            }).addTo(map);

            updateBuses();
            setInterval(updateBuses, 3000);

            // Load initial location data
            loadHostels();
            loadClasses();
            loadRoutes();
            loadBusRoutes();

            // populate track select (1..20)
            const sel = document.getElementById('trackBusSelect');
            for (let i = 1; i <= 20; i++) {
                const opt = document.createElement('option');
                opt.value = String(i);
                opt.textContent = `Bus ${i}`;
                sel.appendChild(opt);
            }

            sel.addEventListener('change', () => {
                const val = sel.value;
                setTrackedBus(val || null);
            });

            document.getElementById('followCheckbox').addEventListener('change', (e) => {
                followEnabled = e.target.checked;
            });

            // Add layer toggle listeners
            document.getElementById('hostelsToggle').addEventListener('change', (e) => {
                updateLayerVisibility('hostels', e.target.checked);
            });

            document.getElementById('classesToggle').addEventListener('change', (e) => {
                updateLayerVisibility('classes', e.target.checked);
            });

            document.getElementById('routesToggle').addEventListener('change', (e) => {
                updateLayerVisibility('routes', e.target.checked);
            });
        }

        function updateBuses() {
            fetch('/api/buses')
                .then(response => response.json())
                .then(buses => {
                    const busNumbers = Object.keys(buses);
                    document.getElementById('busCount').textContent = busNumbers.length;

                    const existingBuses = Object.keys(busMarkers);
                    existingBuses.forEach(busNum => {
                        if (!busNumbers.includes(busNum)) {
                            map.removeLayer(busMarkers[busNum]);
                            delete busMarkers[busNum];
                        }
                    });

                    busNumbers.forEach(busNum => {
                        const bus = buses[busNum];
                        const position = [bus.lat, bus.lng];
                        const color = colors[(parseInt(busNum) - 1) % colors.length];
                        
                        let rotation = 0;
                        if (prevBusPositions[busNum]) {
                            rotation = calcBearing(prevBusPositions[busNum], position);
                        }
                        prevBusPositions[busNum] = position;

                        if (busMarkers[busNum]) {
                            busMarkers[busNum].setLatLng(position);
                            const isTracked = trackedBus && busNum === trackedBus;
                            const newIcon = createIcon(busNum, color, isTracked ? 70 : 40, rotation);
                            busMarkers[busNum].setIcon(newIcon);
                        } else {
                            // size depends on whether this is tracked
                            const isTracked = trackedBus && busNum === trackedBus;
                            const icon = createIcon(busNum, color, isTracked ? 70 : 40, rotation);
                            busMarkers[busNum] = L.marker(position, { icon: icon, title: `Bus ${busNum}` }).addTo(map);
                            busMarkers[busNum].on('click', () => {
                                setTrackedBus(busNum);
                                if (followEnabled) map.setView(position, 17);
                            });
                            // Pause follow while hovering the bus marker
                            busMarkers[busNum].on('mouseover', () => { followEnabled = false; });
                            busMarkers[busNum].on('mouseout', () => { followEnabled = document.getElementById('followCheckbox').checked; });
                        }

                        // apply fading and follow when updating
                        const marker = busMarkers[busNum];
                        const isTrackedNow = trackedBus && busNum === trackedBus;
                        try { marker.setOpacity(isTrackedNow ? 1 : 0.2); } catch(e) {}
                        if (isTrackedNow && followEnabled) {
                            map.panTo(position);
                        }
                    });

                    updateActiveBusList(busNumbers, buses);
                    const now = new Date().toLocaleTimeString();
                    document.getElementById('lastUpdate').textContent = now;
                })
                .catch(error => console.error('Error:', error));
        }

        function updateActiveBusList(busNumbers, buses) {
            const container = document.getElementById('activeBuses');
            
            if (busNumbers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                            <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z"/>
                        </svg>
                        <p>No buses currently active</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            busNumbers.sort((a, b) => parseInt(a) - parseInt(b));

            busNumbers.forEach(busNum => {
                const color = colors[(parseInt(busNum) - 1) % colors.length];
                const item = document.createElement('div');
                item.className = 'bus-item';
                item.style.borderLeftColor = color;
                item.onclick = () => {
                    const position = [buses[busNum].lat, buses[busNum].lng];
                    map.setView(position, 17);
                };
                item.innerHTML = `
                    <div class="bus-info">
                        <div class="bus-dot" style="background-color: ${color};">${busNum}</div>
                        <div class="bus-name">Bus ${busNum}</div>
                    </div>
                    <div class="bus-status">
                        <div class="pulse"></div>
                        Active
                    </div>
                `;
                container.appendChild(item);
            });
        }

        window.addEventListener('load', initMap);
    </script>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>